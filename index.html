<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SonicVault v6.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --glass: rgba(15, 20, 25, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --accent: #60a5fa;
            --accent-dim: rgba(96, 165, 250, 0.15);
            --bg-hue: 220;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text);
            overflow: hidden;
            user-select: none;
        }

        /* LAYERS */
        #bg-layer {
            position: absolute; inset: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, 
                hsl(var(--bg-hue), 80%, 20%) 0%, 
                #000000 70%);
            opacity: 0.4; z-index: -3; filter: blur(80px);
            transition: background 0.5s;
            animation: spin-slow 60s linear infinite;
        }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

        #beat-flash {
            position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 700px; height: 700px;
            background: radial-gradient(closest-side, var(--accent) 0%, transparent 100%);
            mix-blend-mode: screen; opacity: 0; pointer-events: none; z-index: -2;
            transition: opacity 0.08s ease-out;
            border-radius: 50%;
        }

        #vizCanvas {
            position: absolute; inset: 0; width: 100%; height: 100%; z-index: -1;
        }

        /* LIQUID GLASS UI */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3), inset 0 0 0 1px rgba(255,255,255,0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .glass-panel:hover { border-color: rgba(255,255,255,0.2); }

        /* TOP BAR */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
        }

        /* PLAYER CARD */
        .player-wrapper {
            position: absolute; top: 45%; left: 50%; 
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 400px; z-index: 10;
            transition: transform 0.05s;
        }

        .art-container {
            position: relative; width: 260px; height: 260px; 
            margin-bottom: 2rem; display: flex; align-items: center; justify-content: center;
        }
        
        .album-art {
            width: 100%; height: 100%; background-size: cover; background-position: center;
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            position: relative; z-index: 5; border: 1px solid var(--glass-border);
            transition: border-radius 0.3s;
            background-color: #111; display: flex; align-items: center; justify-content: center;
        }
        .album-art.circle { border-radius: 50%; width: 200px; height: 200px; }

        .track-info { text-align: center; width: 100%; padding: 0 20px; }
        .track-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 4px; text-shadow: 0 0 20px var(--accent-dim); }
        .track-meta { font-size: 0.75rem; font-weight: 600; letter-spacing: 2px; opacity: 0.6; text-transform: uppercase; }

        /* SCRUBBER */
        .scrubber { width: 100%; margin-top: 20px; padding: 0 20px; position: relative; }
        input[type=range].seek-bar {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; z-index: 20; position: relative;
        }
        input[type=range].seek-bar::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        input[type=range].seek-bar::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: var(--accent); margin-top: -4px; box-shadow: 0 0 10px var(--accent);
        }
        .time-labels { display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace; font-size: 10px; opacity: 0.5; margin-top: 5px; }

        /* CONTROLS BAR */
        .controls {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 15px;
            padding: 12px 30px; border-radius: 50px; z-index: 50;
        }

        .btn {
            width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05); color: #fff; font-size: 16px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn:hover { background: var(--accent); border-color: var(--accent); transform: scale(1.1); color: white; }
        .btn.main { width: 64px; height: 64px; font-size: 24px; background: #fff; color: black; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .btn.main:hover { transform: scale(1.05); box-shadow: 0 0 30px var(--accent); background: #fff; color: black; }
        .btn.active { color: var(--accent); border-color: var(--accent); background: var(--accent-dim); }
        .btn:hover.active { color: white; }

        /* VOLUME SLIDER */
        .vol-container { position: relative; }
        .vol-popup {
            position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 140px; background: var(--glass);
            border-radius: 20px; border: 1px solid var(--glass-border);
            display: flex; justify-content: center; padding: 15px 0;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease 0.5s; 
            z-index: 100;
        }
        .vol-bridge { position: absolute; bottom: 0; left: -20px; right: -20px; height: 80px; }
        .vol-container:hover .vol-popup, .vol-popup:hover { opacity: 1; pointer-events: auto; transition-delay: 0s; }

        input[type=range].vol-slider {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 6px; height: 100%;
            accent-color: var(--accent); background: transparent;
        }

        /* PANELS */
        .side-panel {
            position: absolute; top: 0; bottom: 0; width: 360px; max-width: 90%;
            z-index: 60; transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            display: flex; flex-direction: column;
            background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--accent-dim);
            backdrop-filter: blur(40px);
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .left-panel { left: 20px; top: 20px; bottom: 20px; border-radius: 30px; transform: translateX(-150%); }
        .right-panel { right: 20px; top: 20px; bottom: 20px; border-radius: 30px; transform: translateX(150%); }
        .side-panel.open { transform: translateX(0); }

        .panel-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; letter-spacing: 1px; color: var(--accent); }
        .panel-content { padding: 20px; overflow-y: auto; flex-grow: 1; }

        /* LIST & DRAG DROP STYLES */
        .list-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 16px; cursor: pointer; transition: 0.2s, opacity 0.3s, transform 0.3s;
            margin-bottom: 4px; border: 1px solid transparent;
            user-select: none;
        }
        
        .list-item.fading-out { opacity: 0; transform: scale(0.9); pointer-events: none; height: 0; padding: 0; margin: 0; overflow: hidden; }

        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { background: var(--accent-dim); border-color: var(--accent); }
        
        .list-item.dragging { opacity: 0.5; background: var(--accent-dim); transform: scale(0.98); }
        .list-item.drag-over { border-top: 2px solid var(--accent); }
        .folder-drag-over { background: rgba(255,255,255,0.1); border: 1px dashed var(--accent); }

        .folder-header { display: flex; align-items: center; gap: 10px; width: 100%; }
        .folder-content { margin-left: 20px; padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.1); display: none; }
        .folder-content.expanded { display: block; }
        
        .action-btn { opacity: 0.4; transition: 0.2s; padding: 6px; z-index: 10; }
        .action-btn:hover { opacity: 1; transform: scale(1.1); color: var(--accent); }
        .action-btn.del:hover { color: #ef4444; }
        
        /* Curve Editor */
        .curve-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.9);
            width: 600px; height: 400px; z-index: 70; opacity: 0; pointer-events: none;
            transition: 0.3s; padding: 20px; display: flex; flex-direction: column;
            border-radius: 30px;
        }
        .curve-modal.open { transform: translate(-50%,-50%) scale(1); opacity: 1; pointer-events: auto; }

        /* UTILS */
        .hidden { display: none !important; }
        input[type=range].setting-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        input[type=range].setting-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); margin-top: -6px; transition: transform 0.1s; }
        input[type=range].setting-slider:hover::-webkit-slider-thumb { transform: scale(1.2); }
        
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--accent-dim); border: 1px solid var(--accent); color: white; font-weight: bold; }
    </style>
</head>
<body>

    <!-- LAYERS -->
    <div id="bg-layer"></div>
    <div id="beat-flash"></div>
    <canvas id="vizCanvas"></canvas>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="text-xl font-black tracking-tighter">SONIC<span style="color:var(--accent)">VAULT</span> <span class="text-xs opacity-50 font-normal">v6.6</span></div>
        <div class="flex gap-3">
            <button onclick="window.ui.toggleLibrary()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/10" title="Library"><i class="fa-solid fa-music"></i></button>
            <button onclick="window.ui.toggleSettings()" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/10" title="Settings"><i class="fa-solid fa-sliders"></i></button>
        </div>
    </div>

    <!-- CENTER PLAYER -->
    <div class="player-wrapper" id="playerWrapper">
        <div class="art-container" id="artContainer">
            <div class="album-art circle glass-panel" id="albumArt">
                <i class="fa-solid fa-music text-5xl opacity-30" id="artPlaceholder"></i>
            </div>
        </div>

        <div class="track-info">
            <div class="flex justify-center gap-2 mb-2" id="metaTags"></div>
            <div class="track-title truncate" id="trackTitle">Select Track</div>
            <div class="track-meta" id="trackArtist">Local Audio</div>
        </div>

        <div class="scrubber">
            <input type="range" class="seek-bar" id="progressBar" min="0" max="100" value="0">
            <div class="time-labels">
                <span id="currTime">0:00</span>
                <span id="totTime">--:--</span>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="glass-panel controls">
        <button class="btn" onclick="player.toggleRepeat()" id="btnLoop"><i class="fa-solid fa-repeat"></i></button>
        <button class="btn" onclick="curveEditor.open()"><i class="fa-solid fa-wave-square"></i></button>
        
        <button class="btn" onclick="player.prev()"><i class="fa-solid fa-backward-step"></i></button>
        <button class="btn main" onclick="player.togglePlay()" id="btnPlay"><i class="fa-solid fa-play ml-1"></i></button>
        <button class="btn" onclick="player.next()"><i class="fa-solid fa-forward-step"></i></button>
        
        <div class="vol-container">
            <div class="vol-bridge"></div>
            <div class="vol-popup glass-panel">
                <input type="range" class="vol-slider" min="0" max="1" step="0.01" value="1" oninput="audioSys.setVolume(this.value)">
            </div>
            <button class="btn"><i class="fa-solid fa-volume-high"></i></button>
        </div>
    </div>

    <!-- LEFT PANEL: LIBRARY -->
    <aside class="side-panel left-panel" id="libraryPanel">
        <div class="panel-header">
            <span>COLLECTION</span>
            <div class="flex gap-2">
                <button onclick="window.libraryMgr.openFolderModal()" title="New Folder"><i class="fa-solid fa-folder-plus text-white hover:text-[var(--accent)]"></i></button>
                <button onclick="window.ui.toggleLibrary()"><i class="fa-solid fa-xmark text-white hover:text-[var(--accent)]"></i></button>
            </div>
        </div>
        <div class="p-4 border-b border-white/10">
            <label class="block w-full py-4 text-center border border-dashed border-white/30 rounded-xl cursor-pointer hover:bg-white/5 hover:border-[var(--accent)] transition">
                <span class="text-xs font-bold uppercase tracking-widest text-[var(--accent)]"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> Add Songs</span>
                <input type="file" id="fileInput" accept="audio/*" multiple class="hidden" onchange="window.player.handleUpload(this)">
            </label>
        </div>
        <div class="panel-content custom-scrollbar space-y-1" id="libraryList"></div>
        <div class="p-4 border-t border-white/10">
             <button onclick="window.player.db.clearAll()" class="text-[10px] text-red-400 w-full text-center uppercase hover:text-white tracking-wider font-bold">Factory Reset</button>
        </div>
    </aside>

    <!-- RIGHT PANEL: SETTINGS -->
    <aside class="side-panel right-panel" id="settingsPanel">
        <div class="panel-header">
            <span>AUDIO ENGINE</span>
            <button onclick="window.ui.toggleSettings()"><i class="fa-solid fa-xmark text-white hover:text-[var(--accent)]"></i></button>
        </div>
        <div class="panel-content space-y-8">
            <div class="space-y-4">
                <label class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Visuals</label>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Theme Color</span>
                    <input type="color" id="colorPicker" value="#60a5fa" oninput="window.ui.setTheme(this.value)" class="w-8 h-8 rounded-lg cursor-pointer border-0 p-0 bg-transparent">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Visualizer</span>
                    <button onclick="window.viz.toggleMode()" id="vizModeBtn" class="text-[10px] bg-white/5 border border-white/10 px-3 py-1 rounded-lg hover:bg-[var(--accent)] hover:text-white transition">RING</button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Liquid Lines (Smooth)</span>
                    <input type="checkbox" checked onchange="window.viz.smooth=this.checked" class="accent-[var(--accent)] w-4 h-4">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs">Beat Flash</span>
                    <input type="checkbox" checked onchange="window.viz.flash=this.checked; if(!this.checked)window.viz.clearFlash()" class="accent-[var(--accent)] w-4 h-4">
                </div>
            </div>
            <hr class="border-white/10">
            <div class="space-y-5">
                <label class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Processors</label>
                <div>
                    <div class="flex justify-between text-xs mb-2 font-bold"><span>Bass Boost</span> <span id="bassVal" class="text-[var(--accent)]">0dB</span></div>
                    <input type="range" class="setting-slider" min="0" max="40" value="0" oninput="window.audioSys.setBass(this.value)">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-2 font-bold"><span>Reverb</span> <span id="reverbVal" class="text-[var(--accent)]">0%</span></div>
                    <input type="range" class="setting-slider" min="0" max="100" value="0" oninput="window.audioSys.setReverb(this.value)">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-2 font-bold"><span>Warp (Pitch/Speed)</span> <span id="pitchVal" class="text-[var(--accent)]">1.0x</span></div>
                    <input type="range" class="setting-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="window.audioSys.setBaseSpeed(this.value)">
                </div>
                <div class="flex justify-between items-center bg-red-500/10 border border-red-500/30 p-3 rounded-xl">
                    <span class="text-xs font-bold text-red-400 flex items-center gap-2"><i class="fa-solid fa-burst"></i> XTREME BASS</span>
                    <input type="checkbox" id="xtremeToggle" class="w-4 h-4 accent-red-500" onchange="window.audioSys.toggleXtreme()">
                </div>
            </div>
            <div class="flex justify-between items-center pt-2">
                <span class="text-xs">Auto-DJ Crossfade</span>
                <input type="checkbox" id="autoDjToggle" class="accent-[var(--accent)] w-4 h-4" onchange="window.player.autoDj=this.checked">
            </div>
        </div>
    </aside>

    <!-- CURVE EDITOR -->
    <div class="glass-panel curve-modal" id="curveEditor">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-[var(--accent)]">Speed Curve</h3>
            <button onclick="window.curveEditor.close()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex gap-2 mb-2 overflow-x-auto pb-2" id="presetList"></div>
        <div class="flex-grow relative bg-black/30 rounded-lg mb-2 overflow-hidden cursor-crosshair border border-white/10">
            <canvas id="curveCanvas" width="560" height="250" class="w-full h-full"></canvas>
            <div class="absolute top-0 bottom-0 left-0 w-px bg-white/50 pointer-events-none" id="playhead"></div>
            <div class="absolute top-1/2 left-0 right-0 h-px bg-white/10 pointer-events-none"></div>
        </div>
        <div class="flex justify-between text-xs opacity-60">
            <span>Click to Add • Drag • Dbl-Click Delete</span>
            <div class="flex gap-3">
                <button onclick="window.curveEditor.openSaveModal()" class="hover:text-white">Save Preset</button>
                <button onclick="window.curveEditor.reset()" class="hover:text-red-400">Reset</button>
            </div>
        </div>
    </div>

    <!-- PRESET SAVE MODAL -->
    <div class="glass-panel" id="presetModal" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; padding:20px; border-radius:20px; width:300px; opacity:0; pointer-events:none; transition:0.2s;">
        <h3 class="font-bold mb-3 text-[var(--accent)]">Save Preset</h3>
        <input type="text" id="presetNameInput" placeholder="Preset Name" class="w-full bg-white/5 border border-white/10 rounded p-2 mb-3 text-sm text-white outline-none focus:border-[var(--accent)]">
        <div class="flex justify-end gap-2">
            <button onclick="window.curveEditor.closeSaveModal()" class="text-xs font-bold px-3 py-1 hover:text-white/80">Cancel</button>
            <button onclick="window.curveEditor.confirmSave()" class="text-xs font-bold bg-[var(--accent)] text-white px-4 py-1 rounded shadow-lg hover:opacity-90">Save</button>
        </div>
    </div>
    
    <!-- FOLDER CREATE MODAL -->
    <div class="glass-panel" id="folderModal" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; padding:20px; border-radius:20px; width:300px; opacity:0; pointer-events:none; transition:0.2s;">
        <h3 class="font-bold mb-3 text-[var(--accent)]">Create Folder</h3>
        <input type="text" id="folderNameInput" placeholder="Folder Name" class="w-full bg-white/5 border border-white/10 rounded p-2 mb-3 text-sm text-white outline-none focus:border-[var(--accent)]">
        <div class="flex justify-end gap-2">
            <button onclick="window.libraryMgr.closeFolderModal()" class="text-xs font-bold px-3 py-1 hover:text-white/80">Cancel</button>
            <button onclick="window.libraryMgr.confirmCreateFolder()" class="text-xs font-bold bg-[var(--accent)] text-white px-4 py-1 rounded shadow-lg hover:opacity-90">Create</button>
        </div>
    </div>
    
    <!-- ITEM EDITOR (SONG/FOLDER) -->
    <div class="glass-panel" id="trackEditor" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; padding:20px; border-radius:20px; width:300px; opacity:0; pointer-events:none; transition:0.2s;">
        <h3 class="font-bold mb-3 text-[var(--accent)]" id="editorTitle">Edit Item</h3>
        <input type="text" id="editName" class="w-full bg-white/5 border border-white/10 rounded p-2 mb-3 text-sm text-white outline-none focus:border-[var(--accent)]">
        <label class="block w-full p-3 border border-dashed border-white/20 rounded text-center cursor-pointer hover:bg-white/5 mb-3">
            <span class="text-xs font-bold uppercase tracking-wide">Change Image</span>
            <input type="file" id="editArtInput" class="hidden" accept="image/*" onchange="window.ui.previewEditArt(this)">
        </label>
        <div class="flex justify-end gap-2">
            <button onclick="window.ui.closeEditor()" class="text-xs font-bold px-3 py-1 hover:text-white/80">Cancel</button>
            <button onclick="window.ui.saveEditor()" class="text-xs font-bold bg-[var(--accent)] text-white px-4 py-1 rounded shadow-lg hover:opacity-90">Save</button>
        </div>
    </div>

    <script>
        // --- NEW DATABASE ARCHITECTURE (UUID BASED) ---
        class MusicDB {
            constructor() { 
                this.name = "SonicVaultV7.0"; // Bumped version for fresh schema
                this.v = 2; // Force upgrade
                this.db = null; 
            }
            
            async init() { 
                return new Promise(r => {
                    const q = indexedDB.open(this.name, this.v);
                    q.onupgradeneeded = e => {
                        const db = e.target.result;
                        // Nuke old store if exists to prevent conflicts
                        if (db.objectStoreNames.contains("songs")) db.deleteObjectStore("songs");
                        // New Store: Key is explicit 'id' (UUID string), NO autoIncrement
                        db.createObjectStore("songs", { keyPath: "id" });
                    };
                    q.onsuccess = e => { this.db = e.target.result; r(); };
                    q.onerror = e => console.error("DB Error", e);
                }); 
            }

            async add(f) { 
                return new Promise((r, j) => {
                    const id = crypto.randomUUID(); // Generate Hard ID
                    const t = this.db.transaction(["songs"], "readwrite");
                    const req = t.objectStore("songs").add({
                        id: id,
                        name: f.name.replace(/\.[^/.]+$/, ""),
                        blob: f,
                        art: null
                    });
                    req.onsuccess = () => r(id); // Return the UUID
                    req.onerror = j;
                }); 
            }

            async update(id, d) { 
                return new Promise(r => {
                    const t = this.db.transaction(["songs"], "readwrite");
                    const s = t.objectStore("songs");
                    s.get(id).onsuccess = e => {
                        const i = e.target.result;
                        if(i) { Object.assign(i, d); s.put(i).onsuccess = () => r(); }
                    };
                }); 
            }
            
            async delete(id) { 
                return new Promise(r => {
                    const t = this.db.transaction(["songs"], "readwrite");
                    t.objectStore("songs").delete(id).onsuccess = () => r();
                }); 
            }

            async getAll() { 
                return new Promise(r => {
                    const t = this.db.transaction(["songs"], "readonly");
                    t.objectStore("songs").getAll().onsuccess = e => r(e.target.result);
                }); 
            }

            async clearAll() { 
                if(confirm("Factory Reset?")) { 
                    const tx = this.db.transaction(["songs"], "readwrite"); 
                    tx.objectStore("songs").clear(); 
                    localStorage.clear(); 
                    location.reload(); 
                } 
            }
        }

        // --- LIBRARY MANAGER (UUID COMPATIBLE) ---
        class LibraryManager {
            constructor() {
                try {
                    this.structure = JSON.parse(localStorage.getItem('sv_library_struct'));
                } catch(e) {}
                if(!Array.isArray(this.structure)) this.structure = [];
                this.dragSrc = null;
            }

            save() { localStorage.setItem('sv_library_struct', JSON.stringify(this.structure)); }

            sync(songs) {
                // Ghost Protocol: Remove items from local structure that don't exist in DB
                const dbIds = new Set(songs.map(s => s.id));
                const structIds = new Set();
                
                const clean = (list) => {
                    for (let i = list.length - 1; i >= 0; i--) {
                        if (list[i].type === 'song') {
                            if (!dbIds.has(list[i].id)) {
                                list.splice(i, 1); // Remove ghost
                            } else {
                                structIds.add(list[i].id);
                            }
                        } else if (list[i].type === 'folder') {
                            clean(list[i].items);
                        }
                    }
                };
                clean(this.structure);

                // Add new songs from DB that aren't in structure
                songs.forEach(s => {
                    if (!structIds.has(s.id)) this.structure.push({ type: 'song', id: s.id });
                });
                this.save();
                window.ui.renderLibrary();
            }

            // MODAL FOLDER CREATION
            openFolderModal() {
                $('folderModal').style.opacity = '1';
                $('folderModal').style.pointerEvents = 'auto';
                $('folderNameInput').value = '';
                $('folderNameInput').focus();
            }
            closeFolderModal() {
                $('folderModal').style.opacity = '0';
                $('folderModal').style.pointerEvents = 'none';
            }
            confirmCreateFolder() {
                const name = $('folderNameInput').value || "New Folder";
                const folderId = crypto.randomUUID();
                this.structure.unshift({ type: 'folder', id: folderId, name: name, art: null, items: [], isOpen: true });
                this.save();
                this.closeFolderModal();
                window.ui.renderLibrary();
            }

            // ROBUST DELETE: Remove from data -> Save -> Redraw UI
            deleteItem(id) {
                if(!confirm("Delete this item?")) return;
                
                const remove = (list) => {
                    const idx = list.findIndex(x => x.id === id);
                    if(idx > -1) {
                        const item = list[idx];
                        if(item.type === 'song') {
                             // Background DB Cleanup
                             window.player.db.delete(item.id);
                        } else if(item.type === 'folder') {
                            // Dump contents to root if deleting non-empty folder
                            if (item.items.length > 0) this.structure.push(...item.items);
                        }
                        list.splice(idx, 1);
                        return true;
                    }
                    for(let item of list) {
                        if(item.type === 'folder') {
                            if(remove(item.items)) return true;
                        }
                    }
                    return false;
                };
                
                remove(this.structure);
                this.save();
                window.ui.renderLibrary(); // Total Re-render ensuring it's gone
            }

            findItem(id, list = this.structure) {
                for(let item of list) {
                    if(item.id === id) return item;
                    if(item.type === 'folder') {
                        const found = this.findItem(id, item.items);
                        if(found) return found;
                    }
                }
                return null;
            }

            updateFolder(id, data) {
                const folder = this.findItem(id);
                if(folder) {
                    Object.assign(folder, data);
                    this.save();
                    window.ui.renderLibrary();
                }
            }
        }

        // --- AUDIO SYSTEM ---
        class AudioSystem {
            constructor() {
                this.ctx=null; this.audio=new Audio(); this.audio.crossOrigin="anonymous";
                this.src=null; this.analyser=null; this.gain=null; this.bass=null; 
                this.reverb=null; this.revGain=null; 
                this.baseSpeed=1.0;
                this.bassVal = 0;
                this.reverbVal = 0;
                
                this.audio.addEventListener('timeupdate',()=>window.player.onTick());
                this.audio.addEventListener('ended',()=>window.player.onEnd());
            }
            init() {
                if(this.ctx)return;
                const AC=window.AudioContext||window.webkitAudioContext;
                this.ctx=new AC();
                this.src=this.ctx.createMediaElementSource(this.audio);
                
                this.bass=this.ctx.createBiquadFilter();
                this.bass.type="lowshelf"; this.bass.frequency.value=200; 
                
                this.analyser=this.ctx.createAnalyser(); 
                this.analyser.fftSize=512; 
                
                this.reverb=this.ctx.createConvolver();
                this.reverb.buffer=this.impulse(3);
                this.revGain=this.ctx.createGain(); this.revGain.gain.value=0;

                this.gain=this.ctx.createGain(); 
                
                this.src.connect(this.bass);
                this.bass.connect(this.analyser);
                this.bass.connect(this.reverb);
                this.reverb.connect(this.revGain);
                this.revGain.connect(this.gain); 
                this.bass.connect(this.gain);
                this.gain.connect(this.ctx.destination);
                
                window.viz.start();
            }
            impulse(d){const r=this.ctx.sampleRate,l=r*d,b=this.ctx.createBuffer(2,l,r);for(let c=0;c<2;c++){const d=b.getChannelData(c);for(let i=0;i<l;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/l,2);}return b;}
            
            setBass(v){
                if(this.ctx)this.bass.gain.value=v; 
                this.bassVal = v;
                $('bassVal').innerText=`+${v}dB`; 
                localStorage.setItem('sv_bass',v);
                window.ui.updateMetaTags();
            }
            setReverb(v){
                if(this.ctx)this.revGain.gain.value=v/50; 
                this.reverbVal = v;
                $('reverbVal').innerText=v+'%'; 
                localStorage.setItem('sv_reverb',v);
                window.ui.updateMetaTags();
            }
            setVolume(v){if(this.ctx)this.gain.gain.value=v;}
            setBaseSpeed(v) { 
                this.baseSpeed = parseFloat(v); 
                $('pitchVal').innerText=v+"x"; 
                localStorage.setItem('sv_pitch',v); 
                window.ui.updateMetaTags();
            }
            toggleXtreme(){const on=$('xtremeToggle').checked; if(this.ctx){this.bass.frequency.value=on?100:200; this.bass.Q.value=on?10:1;}}
        }

        // --- CURVE EDITOR ---
        class CurveEditor {
            constructor() {
                this.cv=document.getElementById('curveCanvas'); this.ctx=this.cv.getContext('2d');
                this.pts=[{x:0,y:0.5},{x:1,y:0.5}]; this.drag=-1;
                this.presets=JSON.parse(localStorage.getItem('sv_presets'))||[{name:"Normal",pts:[{x:0,y:0.5},{x:1,y:0.5}]},{name:"Slowed",pts:[{x:0,y:0.2},{x:1,y:0.2}]},{name:"Nightcore",pts:[{x:0,y:0.8},{x:1,y:0.8}]}];
                this.cv.addEventListener('mousedown',e=>this.down(e));
                window.addEventListener('mousemove',e=>this.move(e));
                window.addEventListener('mouseup',()=>this.drag=-1);
                this.cv.addEventListener('dblclick',e=>this.dbl(e));
                this.rendPre();
            }
            open(){$('curveEditor').classList.add('open');this.draw()} close(){$('curveEditor').classList.remove('open')}
            getSpeedAt(p){
                this.pts.sort((a,b)=>a.x-b.x);
                let p1=this.pts[0], p2=this.pts[this.pts.length-1];
                for(let i=0;i<this.pts.length-1;i++) if(p>=this.pts[i].x && p<=this.pts[i+1].x){p1=this.pts[i];p2=this.pts[i+1];break;}
                const r=p2.x-p1.x; if(r===0)return this.map(p1.y);
                const t=(p-p1.x)/r;
                const y = p1.y + (p2.y-p1.y)*t;
                return this.map(y);
            }
            map(y){return 0.5+(y*1.5)}
            draw(){
                const w=this.cv.width, h=this.cv.height, ctx=this.ctx;
                ctx.clearRect(0,0,w,h);
                ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
                const col=getComputedStyle(document.documentElement).getPropertyValue('--accent');
                ctx.strokeStyle=col; ctx.lineWidth=3; ctx.beginPath();
                this.pts.sort((a,b)=>a.x-b.x);
                this.pts.forEach((p,i)=>{ const x=p.x*w, y=(1-p.y)*h; if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); });
                ctx.stroke();
                this.pts.forEach(p=>{ ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(p.x*w, (1-p.y)*h, 5, 0, Math.PI*2); ctx.fill(); });
            }
            getPos(e){const r=this.cv.getBoundingClientRect(); return {x:Math.max(0,Math.min(1,(e.clientX-r.left)/r.width)), y:Math.max(0,Math.min(1,1-(e.clientY-r.top)/r.height))}}
            down(e){const p=this.getPos(e), h=this.pts.findIndex(pt=>Math.hypot(pt.x-p.x,pt.y-p.y)<0.05); if(h!==-1)this.drag=h; else {this.pts.push(p);this.draw()}}
            move(e){if(this.drag!==-1){const p=this.getPos(e); if(this.drag===0)this.pts[0].y=p.y; else if(this.drag===this.pts.length-1)this.pts[this.pts.length-1].y=p.y; else this.pts[this.drag]=p; this.draw()}}
            dbl(e){const p=this.getPos(e), h=this.pts.findIndex(pt=>Math.hypot(pt.x-p.x,pt.y-p.y)<0.05); if(h!==-1&&h!==0&&h!==this.pts.length-1){this.pts.splice(h,1);this.draw()}}
            reset(){this.pts=[{x:0,y:0.5},{x:1,y:0.5}];this.draw()}
            
            rendPre(){
                const l=$('presetList'); l.innerHTML=''; 
                this.presets.forEach(p=>{
                    const b=document.createElement('button'); 
                    b.className='preset-chip'; 
                    b.innerText=p.name; 
                    b.onclick = () => {
                        this.pts=JSON.parse(JSON.stringify(p.pts));
                        this.draw();
                    }; 
                    l.appendChild(b)
                })
            }
            
            openSaveModal() {
                $('presetModal').style.opacity = '1';
                $('presetModal').style.pointerEvents = 'auto';
                $('presetNameInput').value = '';
                $('presetNameInput').focus();
            }

            closeSaveModal() {
                $('presetModal').style.opacity = '0';
                $('presetModal').style.pointerEvents = 'none';
            }

            confirmSave() {
                const n = $('presetNameInput').value;
                if (n && n.trim() !== "") {
                    const newPreset = { name: n.trim(), pts: JSON.parse(JSON.stringify(this.pts)) };
                    this.presets.push(newPreset);
                    try { localStorage.setItem('sv_presets', JSON.stringify(this.presets)); } catch(e) { console.error("Storage full"); }
                    this.rendPre(); this.closeSaveModal();
                }
            }
        }

        // --- PLAYER ---
        class Player {
            constructor() {
                this.songs=[]; this.idx=0; this.loop=0; this.autoDj=false;
                this.db=new MusicDB(); this.db.init().then(()=>this.loadLib());
                this.loadSettings();
                this.playlist = []; 
            }
            async handleUpload(i){ 
                for(const f of i.files) {
                    const id = await this.db.add(f); // Get new UUID
                }
                this.loadLib(); 
            }
            async loadLib(){ 
                const dbSongs = await this.db.getAll();
                window.libraryMgr.sync(dbSongs); 
                this.songs = dbSongs;
            }
            
            // FOLDER CONTEXT PLAYBACK LOGIC
            play(targetId, contextList = null) {
                window.audioSys.init();
                
                // If a specific folder list is provided, USE IT.
                if (contextList && Array.isArray(contextList)) {
                    this.playlist = contextList;
                }
                
                let s = this.songs.find(x => x.id === targetId);
                if(!s) return;
                this.currId = s.id; 
                
                window.audioSys.audio.src=URL.createObjectURL(s.blob);
                window.audioSys.audio.preservesPitch=false; 
                window.audioSys.audio.play();
                window.ui.setTrack(s); window.ui.updatePlayBtn(true);
            }

            togglePlay(){ 
                window.audioSys.init(); 
                if(!this.songs.length) return; 
                if(!this.currId) {
                    const flat = window.ui.getFlatList();
                    if(flat.length > 0) this.play(flat[0], flat);
                } 
                else if(window.audioSys.audio.paused){ window.audioSys.audio.play(); window.ui.updatePlayBtn(true); } 
                else { window.audioSys.audio.pause(); window.ui.updatePlayBtn(false); } 
            }
            
            next(){ 
                // STRICT PLAYLIST LOGIC
                const list = this.playlist.length > 0 ? this.playlist : window.ui.getFlatList();
                const currIdx = list.indexOf(this.currId);
                if(currIdx > -1) this.play(list[(currIdx+1)%list.length]);
            }
            prev(){ 
                // STRICT PLAYLIST LOGIC
                const list = this.playlist.length > 0 ? this.playlist : window.ui.getFlatList();
                const currIdx = list.indexOf(this.currId);
                if(currIdx > -1) this.play(list[(currIdx-1+list.length)%list.length]);
            }
            
            onTick(){
                window.ui.updateProgress();
                if(window.audioSys.audio.duration) {
                    const pct = window.audioSys.audio.currentTime/window.audioSys.audio.duration;
                    const speed = window.curveEditor.getSpeedAt(pct);
                    window.audioSys.audio.playbackRate = speed * window.audioSys.baseSpeed;
                    document.getElementById('playhead').style.left=(pct*100)+'%';
                    if(this.autoDj && window.audioSys.audio.duration-window.audioSys.audio.currentTime<5 && !this.fading){
                        this.fading=true; setTimeout(()=>{this.next(); this.fading=false;}, 4500);
                    }
                }
            }
            onEnd(){ if(this.loop===1) this.play(this.currId); else this.next(); }
            toggleRepeat(){ this.loop=(this.loop+1)%2; $('btnLoop').style.color=this.loop?'var(--accent)':'inherit'; }
            
            loadSettings(){
                const b=localStorage.getItem('sv_bass'); if(b) {document.querySelectorAll('input[type=range]')[1].value=b; window.audioSys.setBass(b);}
                const r=localStorage.getItem('sv_reverb'); if(r) {document.querySelectorAll('input[type=range]')[2].value=r; window.audioSys.setReverb(r);}
                const col=localStorage.getItem('sv_theme'); if(col) window.ui.setTheme(col);
            }
        }

        // --- UI ---
        class UI {
            constructor() {
                this.editType=null; this.editId=null; this.tempArt=null;
                $('progressBar').addEventListener('input',e=>{if(window.audioSys.audio.duration)window.audioSys.audio.currentTime=(e.target.value/100)*window.audioSys.audio.duration});
            }

            renderLibrary() {
                const el = $('libraryList'); el.innerHTML = '';
                
                const getIds = (list) => list.map(item => item.id);
                // Root context is only songs at root level
                const rootIds = window.libraryMgr.structure.filter(i => i.type === 'song').map(i => i.id);

                const buildItem = (item, parentList, index) => {
                    const div = document.createElement('div');
                    // Add DOM ID
                    div.id = `item-${item.id}`;
                    div.draggable = true;
                    
                    div.ondragstart = (e) => { e.stopPropagation(); window.libraryMgr.dragSrc = { item, parentList, index }; div.classList.add('dragging'); };
                    div.ondragend = () => { div.classList.remove('dragging'); document.querySelectorAll('.drag-over, .folder-drag-over').forEach(el=>el.classList.remove('drag-over','folder-drag-over')); };
                    div.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); if (item.type === 'folder') div.classList.add('folder-drag-over'); else div.classList.add('drag-over'); };
                    div.ondragleave = () => div.classList.remove('drag-over', 'folder-drag-over');
                    div.ondrop = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        const src = window.libraryMgr.dragSrc;
                        if (!src || (src.item.id === item.id)) return;
                        src.parentList.splice(src.index, 1);
                        if (item.type === 'folder' && div.classList.contains('folder-drag-over')) { item.items.push(src.item); item.isOpen = true; }
                        else { parentList.splice(index, 0, src.item); }
                        window.libraryMgr.save(); this.renderLibrary();
                    };

                    if (item.type === 'song') {
                        div.className = 'list-item';
                        if(window.player.currId === item.id) div.classList.add('active');
                        const song = window.player.songs.find(s => s.id === item.id);
                        if (!song) return null; // Skip if db sync lag
                        
                        div.innerHTML = `<div class="w-6 text-center opacity-50 text-xs"><i class="fa-solid fa-music"></i></div><div class="truncate text-sm font-medium flex-grow">${song.name}</div>`;
                        
                        // Edit Button
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn';
                        editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                        editBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            window.ui.openEdit('song', item.id); 
                        });
                        
                        // Delete Button
                        const delBtn = document.createElement('button');
                        delBtn.className = 'action-btn del';
                        delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                        delBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            window.libraryMgr.deleteItem(item.id); 
                        });
                        
                        div.appendChild(editBtn);
                        div.appendChild(delBtn);
                        
                        // Determine Context
                        const contextIds = parentList === window.libraryMgr.structure ? rootIds : getIds(parentList);
                        
                        div.addEventListener('click', () => {
                            window.player.play(item.id, contextIds);
                        });

                    } else {
                        // Folder
                        const header = document.createElement('div');
                        header.className = 'list-item';
                        header.draggable = true;
                        // Copy drag events
                        header.ondragstart = div.ondragstart; 
                        header.ondragend = div.ondragend;
                        header.ondragover = div.ondragover; 
                        header.ondrop = div.ondrop;
                        
                        const icon = item.art ? `<img src="${item.art}" class="w-6 h-6 rounded-full object-cover">` : `<i class="fa-solid fa-folder text-[var(--accent)]"></i>`;
                        header.innerHTML = `<div class="folder-header"><div class="w-6 text-center">${icon}</div><div class="truncate text-sm font-bold text-[var(--accent)] flex-grow">${item.name}</div></div>`;
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn';
                        editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                        editBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            window.ui.openEdit('folder', item.id); 
                        });
                        
                        const delBtn = document.createElement('button');
                        delBtn.className = 'action-btn del';
                        delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                        delBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            window.libraryMgr.deleteItem(item.id); 
                        });
                        
                        const chevron = document.createElement('i');
                        chevron.className = `fa-solid fa-chevron-${item.isOpen ? 'down' : 'right'} text-xs opacity-50 ml-2`;
                        
                        header.firstChild.appendChild(editBtn);
                        header.firstChild.appendChild(delBtn);
                        header.firstChild.appendChild(chevron);
                        
                        header.addEventListener('click', () => { 
                            item.isOpen = !item.isOpen; 
                            window.libraryMgr.save(); 
                            this.renderLibrary(); 
                        });

                        const content = document.createElement('div');
                        content.className = `folder-content ${item.isOpen ? 'expanded' : ''}`;
                        item.items.forEach((subItem, subIdx) => {
                            const subEl = buildItem(subItem, item.items, subIdx);
                            if(subEl) content.appendChild(subEl);
                        });
                        
                        div.appendChild(header);
                        div.appendChild(content);
                    }
                    return div;
                };

                const rootDiv = document.createElement('div');
                rootDiv.style.minHeight = '100px';
                rootDiv.ondragover = (e) => e.preventDefault();
                rootDiv.ondrop = (e) => {
                    e.preventDefault();
                    if(e.target === rootDiv || e.target === el) {
                        const src = window.libraryMgr.dragSrc;
                        if(src) {
                            src.parentList.splice(src.index, 1);
                            window.libraryMgr.structure.push(src.item);
                            window.libraryMgr.save(); this.renderLibrary();
                        }
                    }
                };
                window.libraryMgr.structure.forEach((item, i) => {
                    const node = buildItem(item, window.libraryMgr.structure, i);
                    if(node) rootDiv.appendChild(node);
                });
                el.appendChild(rootDiv);
            }

            getFlatList() {
                const list = [];
                const scan = (items) => {
                    items.forEach(i => {
                        if(i.type === 'song') list.push(i.id);
                        else if(i.type === 'folder') scan(i.items);
                    });
                };
                scan(window.libraryMgr.structure);
                return list;
            }

            renderList(){ this.renderLibrary(); } 

            updateMetaTags() {
                const c = $('metaTags'); c.innerHTML = '';
                if(window.audioSys.baseSpeed != 1.0) {
                    const t = document.createElement('span'); t.className = 'tag'; 
                    t.innerText = `WARP ${window.audioSys.baseSpeed}x`; c.appendChild(t);
                }
                if(window.audioSys.bassVal > 0) {
                    const t = document.createElement('span'); t.className = 'tag'; 
                    t.innerText = `BASS +${window.audioSys.bassVal}`; c.appendChild(t);
                }
                if(window.audioSys.reverbVal > 0) {
                    const t = document.createElement('span'); t.className = 'tag'; 
                    t.innerText = `REVERB ${window.audioSys.reverbVal}%`; c.appendChild(t);
                }
            }
            
            setTrack(s){
                $('trackTitle').innerText=s.name; $('trackArtist').innerText="Local File";
                if(s.art){$('albumArt').style.backgroundImage=`url(${s.art})`; $('artPlaceholder').style.display='none';}
                else{$('albumArt').style.backgroundImage='none'; $('artPlaceholder').style.display='flex';}
                this.renderLibrary(); 
            }
            updatePlayBtn(p){ $('btnPlay').innerHTML=p?'<i class="fa-solid fa-pause"></i>':'<i class="fa-solid fa-play ml-1"></i>'; }
            updateProgress(){
                const a=window.audioSys.audio; if(!a.duration)return;
                $('progressBar').value=(a.currentTime/a.duration)*100;
                const f=s=>`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
                $('currTime').innerText=f(a.currentTime); $('totTime').innerText=f(a.duration);
            }
            toggleLibrary(){ $('libraryPanel').classList.toggle('open'); }
            toggleSettings(){ $('settingsPanel').classList.toggle('open'); }
            setTheme(c){ 
                document.documentElement.style.setProperty('--accent',c); 
                localStorage.setItem('sv_theme',c); 
                const hex = parseInt(c.replace('#',''), 16);
                const r=(hex>>16)&255, g=(hex>>8)&255, b=hex&255;
                document.documentElement.style.setProperty('--accent-dim', `rgba(${r},${g},${b},0.15)`);
                let min=Math.min(r,g,b), max=Math.max(r,g,b), delta=max-min, h=0;
                if(delta>0) { if(max==r) h=((g-b)/delta)%6; else if(max==g) h=(b-r)/delta+2; else h=(r-g)/delta+4; }
                h = Math.round(h*60); if(h<0)h+=360;
                document.documentElement.style.setProperty('--bg-hue', h);
            }
            
            openEdit(type, id){
                this.editType = type;
                this.editId = id;
                $('trackEditor').style.opacity='1'; $('trackEditor').style.pointerEvents='auto';
                
                if(type === 'song') {
                    const s = window.player.songs.find(x=>x.id===id);
                    $('editorTitle').innerText = "Edit Track";
                    $('editName').value = s ? s.name : "";
                } else {
                    const f = window.libraryMgr.findItem(id);
                    $('editorTitle').innerText = "Edit Folder";
                    $('editName').value = f ? f.name : "";
                }
            }
            closeEditor(){ $('trackEditor').style.opacity='0'; $('trackEditor').style.pointerEvents='none'; this.tempArt=null; }
            previewEditArt(i){ const f=i.files[0]; const r=new FileReader(); r.onload=e=>this.tempArt=e.target.result; r.readAsDataURL(f); }
            async saveEditor(){
                const n=$('editName').value;
                if(this.editType === 'song') {
                    const u={name:n}; if(this.tempArt)u.art=this.tempArt;
                    await window.player.db.update(this.editId, u); 
                    window.player.loadLib();
                } else {
                    const u={name:n}; if(this.tempArt)u.art=this.tempArt;
                    window.libraryMgr.updateFolder(this.editId, u);
                }
                this.closeEditor();
            }
        }

        // --- VISUALIZER ---
        class Visualizer {
            constructor() {
                this.cv=$('vizCanvas'); this.ctx=this.cv.getContext('2d');
                this.mode='ring'; this.smooth=true; this.flash=true; 
                this.resize(); window.addEventListener('resize',()=>this.resize());
            }
            resize(){this.cv.width=window.innerWidth;this.cv.height=window.innerHeight;}
            start(){this.draw()}
            
            toggleMode(){ 
                this.mode=this.mode==='ring'?'bar':'ring'; 
                $('vizModeBtn').innerText=this.mode.toUpperCase(); 
                $('albumArt').className=`album-art glass-panel ${this.mode==='ring'?'circle':''}`; 
            }
            
            clearFlash(){ $('beat-flash').style.opacity=0; }

            getCP(x0,y0,x1,y1,x2,y2){
                const t=0.4;
                const d1=Math.hypot(x1-x0,y1-y0), d2=Math.hypot(x2-x1,y2-y1);
                const fa=t*d1/(d1+d2), fb=t*d2/(d1+d2);
                return [x1-fa*(x2-x0), y1-fa*(y2-y0), x1+fb*(x2-x0), y1+fb*(y2-y0)];
            }

            draw() {
                requestAnimationFrame(()=>this.draw());
                if(!window.audioSys.analyser) return;
                const buf=new Uint8Array(window.audioSys.analyser.frequencyBinCount);
                window.audioSys.analyser.getByteFrequencyData(buf);
                const ctx=this.ctx, w=this.cv.width, h=this.cv.height;
                ctx.clearRect(0,0,w,h);

                let bass=0; for(let i=0;i<4;i++)bass+=buf[i]; bass/=4;
                
                if(this.flash) {
                    const threshold = 120;
                    if(bass > threshold) {
                        const intensity = (bass - threshold) / (255 - threshold);
                        $('beat-flash').style.opacity = intensity * 0.7;
                    } else {
                        $('beat-flash').style.opacity = 0;
                    }
                } else {
                    $('beat-flash').style.opacity = 0;
                }
                
                const totalEnergy = buf.reduce((a,b)=>a+b,0);
                if(totalEnergy < 100) return;

                if(this.mode==='ring') this.drawRing(ctx,w,h,buf);
                else this.drawBars(ctx,w,h,buf);
            }

            drawRing(ctx,w,h,d) {
                const cx=w/2, cy=h/2-40; 
                const r=140; 
                const bars=100; 
                
                const limit = Math.floor(d.length * Math.min(1, window.audioSys.baseSpeed - 0.05));
                const step = Math.floor(limit/bars) || 1;

                const col=getComputedStyle(document.documentElement).getPropertyValue('--accent');
                ctx.strokeStyle=col; ctx.lineWidth=3;
                
                const pts=[];
                for(let i=0; i<bars; i++) {
                    const idx = Math.floor(i*step);
                    const v=d[idx];
                    const val = v * 1.5; 
                    
                    const ang=(i/bars)*Math.PI*2;
                    pts.push({x:cx+Math.cos(ang)*(r+val), y:cy+Math.sin(ang)*(r+val)});
                }
                pts.push(pts[0],pts[1]); 

                if(this.smooth) {
                    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
                    for(let i=1; i<pts.length-2; i++){
                        const p0=pts[i-1], p1=pts[i], p2=pts[i+1];
                        const cp=this.getCP(p0.x,p0.y,p1.x,p1.y,p2.x,p2.y);
                        ctx.bezierCurveTo(cp[2],cp[3], this.getCP(p1.x,p1.y,p2.x,p2.y,pts[i+2].x,pts[i+2].y)[0], this.getCP(p1.x,p1.y,p2.x,p2.y,pts[i+2].x,pts[i+2].y)[1], p2.x,p2.y);
                    }
                    ctx.stroke();
                } else {
                    ctx.beginPath();
                    for(let i=0; i<bars; i++){
                        const ang=(i/bars)*Math.PI*2;
                        const idx = Math.floor(i*step);
                        const x = cx+Math.cos(ang)*(r + d[idx]*1.5);
                        const y = cy+Math.sin(ang)*(r + d[idx]*1.5);
                        ctx.moveTo(cx+Math.cos(ang)*r, cy+Math.sin(ang)*r);
                        ctx.lineTo(x,y);
                    }
                    ctx.stroke();
                }
            }
            
            drawBars(ctx,w,h,d) {
                const cnt=100, sp=w/cnt;
                
                const limit = Math.floor(d.length * Math.min(1, window.audioSys.baseSpeed - 0.05));
                const step = Math.floor(limit/cnt) || 1;

                const col=getComputedStyle(document.documentElement).getPropertyValue('--accent');
                ctx.fillStyle=col;
                
                if(this.smooth) {
                    ctx.beginPath(); ctx.moveTo(0,h);
                    for(let i=0;i<cnt;i++){
                        const idx = Math.floor(i*step);
                        const v=d[idx], y=h-(v/255)*(h*0.8), x=i*sp+sp/2;
                        if(i===0)ctx.lineTo(x,y);
                        else {
                            const prevIdx = Math.floor((i-1)*step);
                            const px=(i-1)*sp+sp/2, py=h-(d[prevIdx]/255)*(h*0.8);
                            ctx.quadraticCurveTo(px,py, (px+x)/2, (py+y)/2);
                        }
                    }
                    ctx.lineTo(w,h); ctx.fill();
                } else {
                    for(let i=0;i<cnt;i++){
                        const idx = Math.floor(i*step);
                        const v=d[idx], bh=(v/255)*(h*0.8);
                        ctx.fillRect(i*sp, h-bh, sp-2, bh);
                    }
                }
            }
        }

        const $ = id => document.getElementById(id);
        window.libraryMgr = new LibraryManager();
        window.audioSys = new AudioSystem();
        window.ui = new UI();
        window.viz = new Visualizer();
        window.player = new Player();
        window.curveEditor = new CurveEditor();
    </script>
    <style>
        .preset-chip { padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 12px; font-size: 10px; cursor: pointer; white-space: nowrap; margin-right: 5px; }
        .preset-chip:hover { background: var(--accent); color: white; }
    </style>
</body>
</html>